<!doctype html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>SISBAJUD | Automação GAEPP</title>
    <style>
        form label[data-label] {
            position: relative;
            display: inline-block;
            margin-top: 1rem;
        }

        form label[data-label] > input {
            padding: 1rem 1rem 0.5rem;
            border: 1px solid #6B7280;
            border-radius: 0.5rem;
            outline: none;
            width: 100%;
        }

        form label[data-label] > input:focus {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        form label[data-label]::before {
            content: attr(data-label);
            position: absolute;
            top: -0.75rem;
            left: 0.75rem;
            background-color: white;
            padding: 0 0.25rem;
            font-size: 0.875rem;
            color: #6B7280;
        }

        form label[data-label]:focus-within::before {
            color: #3B82F6;
        }
    </style>
</head>
<body>
<header class="w-full px-3 py-1 flex justify-center items-center gap-2">
    <h1 class="text-3xl font-bold">
        Automação GAEPP
    </h1>
    <span class="text-3x">•</span>
    <h2 class="text-3xl">SISBAJUD</h2>
</header>
<main class="mt-4">
    <div class="mx-10 flex flex-col gap-4 justify-center">
        <div class="text-lg mx-auto">
            Confirme ou altere os dados abaixo conforme necessário. Prossiga quando todos os dados estiverem válidos.
        </div>
        <ul class="text-base mx-auto list-disc list-inside">
            <li>
                Pontos, hífens e barras em CPFs, CNPJs e números do mandado são opcionais. Em valores monetários,
                somente a vírgula dos centavos é necessária.
            </li>
            <li>
                Os campos marcados com ★ (estrela) ficarão salvos para a próxima visita.
            </li>
        </ul>
        <form class="flex flex-col gap-2 mx-10">
            <div class="flex gap-2">
                <label data-label="Login do SISBAJUD ★" class="w-full">
                    <input name="login" type="text" placeholder="Login do SISBAJUD" data-save/>
                </label>
                <label data-label="Senha do SISBAJUD ★" class="w-full">
                    <input name="senha" type="password" placeholder="Senha do SISBAJUD" data-save/>
                </label>
            </div>
            <label data-label="Juíz ★" class="w-full">
                <input name="juiz" type="text" placeholder="Juíz" data-save/>
            </label>
            <label data-label="Vara" class="w-full">
                <input name="vara" type="text" placeholder="Vara"/>
            </label>
            <label data-label="Número do Mandado" class="w-full">
                <input name="numero_mandado" type="text" placeholder="Número do Mandado"/>
            </label>
            <label data-label="Autor" class="w-full">
                <input name="autor" type="text" placeholder="Autor"/>
            </label>
            <label data-label="Valor da Pesquisa" class="w-full">
                <input name="valor_pesquisa" type="text" placeholder="Valor da Pesquisa"/>
            </label>
            <div>
                <div class="flex gap-2 items-center">
                    <span class="font-semibold text-lg flex-grow">Pesquisados</span>
                    <button type="button" data-list-add="pesquisados"
                            class="rounded-md px-2 py-1 font-semibold bg-blue-400 hover:bg-blue-500 transition-colors">
                        &plus;
                        Adicionar
                    </button>
                </div>
                <ul id="pesquisados">
                    <template>
                        <li>
                            <fieldset class="flex gap-2 w-full">
                                <label data-label="CPF/CNPJ Pesquisado" class="w-full">
                                    <input name="cpf_cnpj" type="text" placeholder="CPF/CNPJ Pesquisado"/>
                                </label>
                                <div class="flex flex-col flex-col-reverse">
                                    <button type="button" data-list-remove
                                            class="h-[50px] flex items-center justify-center font-bold text-white rounded-md aspect-square bg-red-500 hover:bg-red-800 transition-colors">
                                        &times;
                                    </button>
                                </div>
                            </fieldset>
                        </li>
                    </template>
                </ul>
            </div>
            <button type="submit"
                    class="mt-2 px-4 py-2 text-lg font-semibold rounded-lg bg-blue-400 hover:bg-blue-500 transition-colors mx-auto">
                Executar Ordem
            </button>
        </form>
    </div>
</main>
</body>
<script>
    function populateForm(formElement, data) {
        const entries = Object.entries(data)
        console.log(formElement, entries)
        entries.forEach(([key, value]) => {
            const el = formElement.querySelector(`[name="${key}"], #${key}`)
            if (!el) return
            const tag = el.tagName.toLowerCase()
            console.log(key, tag)
            if (tag === "input" || tag === "select" || tag === "textarea")
                el.value = value
            else if (tag === "ul" && Array.isArray(value)) {
                value.forEach(v => {
                    formElement.querySelector(`button[data-list-add='${el.id}']`).click()
                    const items = el.querySelectorAll("li")
                    populateForm(items[items.length - 1], v)
                })
            }
        })
    }

    function implementFormButtons(formElement, onSubmit) {
        formElement.addEventListener("submit", onSubmit)

        const listAddButtons = formElement.querySelectorAll("button[data-list-add]")
        listAddButtons.forEach(button => {
            button.addEventListener("click", (e) => {
                e.preventDefault()
                const list = formElement.querySelector(`#${button.dataset.listAdd}`)
                list.appendChild(list.querySelector("template").content.cloneNode(true))
            })
        })

        const lists = formElement.querySelectorAll("ul")
        lists.forEach(list => {
            list.addEventListener("click", (e) => {
                e.preventDefault()
                if (e.target.dataset.hasOwnProperty("listRemove")) {
                    let el = e.target;
                    while (el !== undefined) {
                        if (el.tagName.toLowerCase() === "li") {
                            el.remove()
                            break;
                        }
                        el = el.parentElement;
                    }
                }
            })
        })
    }

    function formToJson(form) {
        const formData = new FormData(form);
        const json = {};

        formData.forEach((value, key) => {
            if (json[key]) {
                if (!Array.isArray(json[key]))
                    json[key] = [json[key]]
                json[key].push(value)
            } else json[key] = value
        });

        const nestedElements = form.querySelectorAll("ul[id]");
        nestedElements.forEach(ul => {
            const ulId = ul.id;
            json[ulId] = [];
            ul.querySelectorAll("li").forEach(li => {
                const liJson = {}
                li.querySelectorAll("input, select, textarea").forEach(input =>
                    liJson[input.name] = input.value)
                json[ulId].push(liJson);
            });
        });

        return json
    }

    document.addEventListener("DOMContentLoaded", function () {
        const system = "{{ system }}"
        const extractedData = JSON.parse("{{ data }}".replaceAll("&#39;", "\""))
        const savedData = JSON.parse(localStorage.getItem(`${system}-saved`) || "{}")
        const data = {...savedData, ...extractedData}
        const form = document.querySelector("form")

        implementFormButtons(form, (e) => {
            e.preventDefault()

            const savedData = {}
            form.querySelectorAll("[data-save]").forEach(el => {
                if (!el.name || !el.value) return
                savedData[el.name] = el.value
            })
            localStorage.setItem(`${system}-saved`, JSON.stringify(savedData))

            const json = formToJson(form)

            fetch(`/action/${system}/execute`, {
                method: "POST",
                headers: {"content-type": "application/json"},
                body: JSON.stringify(json)
            })
                .catch(err => console.log(err))
                .finally(() => window.location.href = "/action/queued")
        })
        populateForm(form, data)
    })
</script>
</html>